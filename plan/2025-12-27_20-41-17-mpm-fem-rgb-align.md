---
mode: plan
cwd: "F:/workspace/xenmpm"
task: "根据 Report.md 生成执行计划（MPM vs FEM RGB 伪影归因与对齐收敛）"
complexity: medium
tool: mcp__sequential-thinking__sequentialthinking
tool_status: unavailable
total_thoughts: 0
created_at: "2025-12-27T20:41:17+08:00"
---

# Plan: MPM vs FEM RGB 对齐与伪影收敛

🎯 任务概述

当前 MPM vs FEM 的 RGB 观感差异混入了大量“非力学因素”（压头几何/接触面、坐标翻转、摩擦、渲染叠色、marker 语义等），导致出现“矩形整块变暗 + 彩虹 halo + 偏暗偏脏 + marker 静态”等非物理伪影。目标是在不引入过度复杂度的前提下，把这些变量逐项对齐/可控化，并形成可审计的输出与回归检查，使后续差异能被可靠归因。

> 备注：本会话环境未暴露 `mcp__sequential-thinking__sequentialthinking` 工具，因此未能按要求调用；计划内容基于 `Report.md` 的结论与仓库现有实现手工拆解。

📋 执行计划

1. 基线复现与运行清单固化（先让“对比”可重复）
   - 动作：在可运行环境（建议 `xengym` conda + Python 3.9，且具备 `taichi`、`xensesdk.ezgl`）执行基线命令，固定 `--save-dir` 输出结构与 `run_manifest.json`。
   - 产出：一组可追溯输出（FEM/MPM 帧、manifest、metrics、可选 intermediate），并记录“问题截图对应 frame_id”。
   - 验收：同机连续运行两次，`total_frames` 与 frame→phase 映射一致；输出目录结构稳定。

2. 压头几何与接触面统一（优先消除“方形硬边”来源）
   - 动作：
     - 明确对比基线：两边统一使用同一几何（优先：都用 `box`；或都用同一个 tip STL）。
     - 对 `circle_r4.STL` 等资产验证 tip/base：确保 FEM 深度渲染接触的是 `y_max` 端面（r≈4mm 圆端面），而不是 `y_min` 的 15mm 方形底座。
   - 产出：在日志/manifest 中打印“最终生效的 indenter 类型与尺寸（mm）”，并输出端面统计（或接触轮廓尺度）。
   - 验收：FEM 侧接触轮廓外接尺度约 8mm（±1mm），不再出现 15mm 方形底座尺度；MPM/FEM 同帧几何轮廓一致或差异可解释。

3. 坐标系与滑移方向对齐（消除“强边缘在相反侧”）
   - 动作：
     - 统一 dx_slide 的符号约定，并把所有翻转集中到单一函数/单一层（避免物理、渲染、overlay 各自取反）。
     - 增加同帧 pose 对照：记录 FEM `object_pose(x,y,z)` 与 MPM `obstacle_center(x,y,z)`（或等价量），必要时叠加同风格 overlay 作目视闭环。
   - 产出：每帧 pose/控制量日志（或写入 manifest），以及至少一组带 overlay 的保存帧用于验证左右一致。
   - 验收：同一阶段内（press/slide）两侧压头 x 方向单调性一致；“强边缘出现在相反侧”的现象消失或能被日志解释为渲染可视化差异。

4. 摩擦参数对齐（把剪切带差异从“参数量级”中解耦）
   - 动作：提供“一键对齐”入口（例如 `--fric` 同时控制 FEM `fric_coef` 与 MPM `mu_s/mu_k`），并在运行清单中记录生效值。
   - 产出：对齐前/后同一基线命令的输出（至少 1 次），以及 manifest 中的摩擦参数回显。
   - 验收：滑移阶段的剪切带/粘滑特征不再被摩擦数量级差异主导（至少观感收敛，且中间量/pose 对齐后可解释）。

5. 渲染策略对齐：tint/marker 语义可控化（先让“看起来像”不被非物理叠色污染）
   - 动作：
     - 基线默认关闭 MPM `depth tint`（或确保 `--mpm-depth-tint off` 是推荐基线的一部分）。
     - 对齐 marker：增加 FEM 侧 marker 开关（白底/marker），MPM 侧默认用 `warp`（能体现面内位移），并确保每帧 `uv_disp_mm` 正确更新。
   - 产出：至少两组对比输出：`marker=off`（只看光照+形变）与 `marker=on/warp`（看位移语义）。
   - 验收：关闭 tint 后，“整块矩形变暗/偏脏”显著收敛；启用 warp 后，MPM marker 在接触附近出现可观测的局部位移/剪切（与 FEM 方向一致）。

6. 若仍存在彩虹 halo：高度场重建/平滑策略迭代（控制台阶与尖锐法线）
   - 动作（按优先级由轻到重）：
     - 仅调参验证：提高高度场平滑强度/核大小，或在渲染前对高度场做更稳健的插值/降噪。
     - 若台阶来自 “max-per-cell”：改为加权 splat/局部拟合（避免硬边），并保持可回退开关。
   - 产出：一组 halo “前/后”对比帧 + 导出的 height_field 中间量（便于复盘）。
   - 验收：halo 强度/范围下降且不会抹掉接触形变主结构；中间量显示台阶被显著削弱。

7. 中间产物与差异指标落盘（形成可审计证据链）
   - 动作：
     - MPM：导出 `height_field_mm`、`uv_disp_mm`、接触近似 mask（例如 `height_field<thr`）。
     - FEM：导出 `get_height()`（可下采样到同分辨率）、`get_marker_displacement()`、必要时导出接触节点/力（已有接口则复用）。
     - 输出逐帧 RGB diff metrics（MAE/分位数/ROI 指标），并与 frame_id 对齐。
   - 产出：`metrics.csv`/`metrics.json` + `intermediate/frame_XXXX.npz`（可选抽样/压缩）。
   - 验收：同帧可用中间量把差异归因到（几何/坐标/摩擦/渲染）中的某一类；指标可重复计算且与输出帧严格对齐。

8. 回归测试与文档沉淀（防回退）
   - 动作：
     - 补充 smoke/regression：覆盖几何端面统计、翻转约定、CLI 参数生效值回显、输出结构（manifest/metrics/intermediate）。
     - 文档沉淀：在 `Report.md` 或专门文档中固化“推荐基线命令 + 排查 checklist + 常见伪影对应开关”。
   - 产出：`quick_test.py`/`example/test_*.py`（依赖缺失时可跳过但要给出清晰提示）、更新后的文档段落。
   - 验收：本机 `python quick_test.py` 通过；在完整依赖环境下跑一次基线命令可产出完整审计链路。

⚠️ 风险与注意事项

- 环境风险：当前工作区 Python=3.13，与 `xensesdk` 的 cp39 二进制不兼容；计划执行需切换到可运行环境（建议 conda Python 3.9）。
- 默认行为风险：对齐项（尤其 tint/marker/几何默认值）尽量通过 CLI 开关与 manifest 固化，避免“静默改变默认表现”影响旧 demo。
- 坐标翻转风险：翻转逻辑分散会导致“修一处坏一处”，必须先收敛到单一入口并用 pose 日志闭环验证。
- 性能/体积风险：导出 intermediate 可能产生大量数据，必须提供抽样频率与开关（默认关闭）。

📎 参考

- `Report.md:1`
- `example/mpm_fem_rgb_compare.py:585`（DepthRenderScene / FEM 深度链路）
- `example/mpm_fem_rgb_compare.py:743`（MPMHeightFieldRenderer / height_field 提取）
- `example/mpm_fem_rgb_compare.py:990`（MPMSensorScene / marker+tint 渲染策略）
- `example/mpm_fem_rgb_compare.py:1362`（MPMSimulationAdapter / MPM 轨迹与压头配置）
- `example/mpm_fem_rgb_compare.py:1660`（RGBComparisonEngine / 对比运行与输出）
- `xengym/render/sensorScene.py:268`（FEM step + get_image/diff 入口）
- `xengym/fem/simulation.py:393`（FEM get_depth / marker displacement）
- `xengym/assets/data/light.txt:1`（光源配置，halo 的颜色来源）

