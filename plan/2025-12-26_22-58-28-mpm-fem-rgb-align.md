---
mode: plan
cwd: F:\workspace\xenmpm
task: 根据 Report.md 制定 MPM/FEM RGB 对齐执行计划
complexity: medium
tool: mcp__sequential-thinking__sequentialthinking
tool_available: false
total_thoughts: 7
created_at: 2025-12-26T22:58:28+08:00
---

# Plan: MPM/FEM RGB 对齐与可诊断化

🎯 任务概述

当前 MPM vs FEM 的 RGB 对比结果被“几何体不一致 / STL 资产接触面错误 / 摩擦不一致 / 坐标翻转与滑移符号不统一 / 渲染策略不同”等因素显著污染，导致无法把差异可靠归因到 MPM 物理本身。本计划目标是先把 **对比基线对齐**，并补齐 **可诊断输出**，让后续能稳定定位到“物理差异”。

> 备注：本运行环境未暴露 `mcp__sequential-thinking__sequentialthinking` 工具，因此本计划为离线分解；后续如工具可用，可在同一 plan 文件中追加“修订记录”。

📋 执行计划

1. 冻结复现基线与输入参数
   - 产出：记录一条“可复现命令”（含 `--mode/--press-mm/--slide-mm/--steps/--indenter-type/--object-file/--mpm-marker/...`）以及对应输出目录结构。
   - 完成标准：在 `--save-dir` 下能得到连续帧的 `fem_####.png/mpm_####.png`，并能明确指出截图对应的 `frame_id`。

2. 统一压头几何体与“接触面朝向”
   - 目标：消除“MPM=SDF box vs FEM=STL”的基线失效；同时修正 `circle_r4.STL` 实际接触面是 15mm 方底座的问题。
   - 实施要点：
     - 明确对比标准：优先选“双方都用 box（尺寸明确）”或“双方都用同一个 tip-only STL”二选一。
     - 修正 FEM 侧 DepthRenderScene 的变换组合：避免 `setTransform()` 覆盖构造时 `.rotate/.translate` 导致朝向丢失（应把固定姿态与每帧位姿做矩阵复合）。
     - 如决定走 STL：准备/生成“仅 tip 接触面”的 STL（或在渲染中强制使用 tip 端面对向胶面）。
   - 完成标准：FEM 渲染出来的接触轮廓不再出现 15mm 方框底座特征；MPM/FEM 的压头轮廓在同一帧内形状一致。

3. 轨迹表统一（frame → press/slide/pose）
   - 目标：保证同一 `frame_id` 对应同一物理阶段与同一压头位姿。
   - 实施要点：
     - 以 `mpm_sim.frame_controls` 为单一真源，生成显式 trajectory table（建议 CSV/JSON）。
     - FEM 渲染与 MPM overlay/日志统一从该表读取（移除/禁用“按比例 fallback”的分支，或仅在无 MPM 时启用）。
   - 完成标准：日志中同一 `frame_id` 的 press/slide 在 FEM/MPM 两侧一致，且分段边界（press/slide/hold）一致。

4. 坐标系与滑移正方向统一（集中式转换，杜绝散落取反）
   - 目标：消除“多处 -dx 修正”导致的左右颠倒；让“+slide”在两边都对应同一屏幕方向。
   - 实施要点：
     - 引入集中式坐标约定（例如 `to_sensor_xy()` / `to_mesh_col_row()`），把所有 x 翻转收敛到一个位置。
     - 统一 `dx_slide` 的符号语义：物理、渲染、overlay、日志使用同一符号；禁止再出现“物理里 -dx，overlay 又 -dx”的叠加。
     - 增加最小诊断：每帧打印（或写入 CSV）`obstacle_center.x` 的单调性、overlay 箭头方向。
   - 完成标准：开启 `--mpm-show-indenter` 时，压头 overlay 与实际 `obstacle_center` 的移动方向一致；FEM 与 MPM 的“强边缘侧”不再呈系统性镜像。

5. 摩擦参数对齐（先对齐数量级，再调参）
   - 目标：避免“摩擦差异”掩盖物理差异。
   - 实施要点：
     - 增加 CLI：`--fem-mu`、`--mpm-mu-s/--mpm-mu-k`（或统一 `--mu` 并映射到两侧）。
     - 初始对齐策略：先把 MPM `mu_s/mu_k` 调到与 FEM 默认 `0.4` 同量级，再根据对比结果微调。
   - 完成标准：同一轨迹下，两侧剪切带形态不再出现“一个粘住拖拽、一个几乎全滑”的极端分裂。

6. 渲染策略对齐（先“可比”，再“好看”）
   - 目标：把“渲染差异”从“物理差异”里剥离。
   - 实施要点：
     - 为 MPM 增加开关：可禁用 depth tint（避免大块偏黑/偏红）。
     - 明确对比模式矩阵：`marker=off/white/warp` 与 `mode=raw/diff` 的推荐组合，并把默认值调整为“最可比”的组合。
     - 检查投影尺度一致性：`gel_size_mm` vs `cam_view_width/height` 是否需要对齐或加注释/约束。
   - 完成标准：在 `marker=off` 情况下，两侧 RGB 的亮暗分布主要由形变决定；开启 marker 后差异可追踪到位移/法线而非渲染偏置。

7. 输出中间产物与结构化日志（让差异可定位）
   - 目标：不仅看 RGB，还能定位到 height/normal/contact 的哪一步开始分叉。
   - 实施要点：
     - 保存：MPM `height_field_mm`、`|uv_disp_mm|`、近似 contact mask；FEM `get_height()`（或等价 depth/height）、接触节点/力（如可用）。
     - 保存统一 `metadata.csv/json`：每帧 `frame_id, press_mm, slide_mm, fem_pose(x,y,z), mpm_center(x,y,z), mu...`。
   - 完成标准：给定任意一帧差异图，能反查对应的 height/uv/contact 与位姿，并判断差异来自“物理”还是“坐标/渲染”。

8. 验收与回归（最小可追踪指标）
   - 验收指标（建议至少满足 3 条）：
     - 几何：接触轮廓一致（无 15mm 方底座假轮廓）。
     - 轨迹：同帧位姿一致（press/slide/center 对齐）。
     - 方向：+slide 在两侧呈同向视觉运动（overlay/位移场一致）。
     - 渲染：关闭 tint/marker 后，RGB 差异显著收敛。
   - 回归方式：补一个轻量脚本/测试（只检查元数据对齐与帧数/边界，不跑完整 GUI）。

⚠️ 风险与注意事项

- 资产修改风险：若生成 tip-only STL，需避免影响其它 demo 的默认行为（建议新增文件而非覆盖原 STL，并更新调用点）。
- 坐标修正风险：把翻转从多处收敛到一处可能会“看起来全变了”，但这是预期；需要用结构化日志验证单调性与方向。
- 依赖/环境风险：ezgl/taichi/GUI 在不同机器上可用性不同；诊断输出应尽量支持 headless（不依赖窗口）。
- 性能风险：导出中间产物可能增大 IO；默认关闭，按需开启。

📎 参考

- `Report.md:1`
- `example/mpm_fem_rgb_compare.py:425`（DepthRenderScene 与 FEM 渲染入口）
- `example/mpm_fem_rgb_compare.py:1030`（MPM height_field 翻转与 tint 入口）
- `example/mpm_fem_rgb_compare.py:1127`（MPM 轨迹与 obstacle 更新）
- `xengym/fem/simulation.py:233`（FEM 摩擦系数）
- `xengym/render/sensorScene.py:197`（FEM 侧 GLSurfMeshItem 的 x/y_range 约定）
- `xengym/assets/obj/circle_r4.STL`（含方形底座的资产）

