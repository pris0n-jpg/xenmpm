---
mode: plan
cwd: F:\workspace\xenmpm
task: 根据 Report_baseline_rerun_2026-01-01.md 收敛 baseline（marker warp/位移场/高度场）
complexity: medium
tool: mcp__sequential-thinking__sequentialthinking
total_thoughts: 7
created_at: 2026-01-02T00:01:09+08:00
---

# Plan: baseline 复跑问题收敛（marker warp/位移场/高度场）

🎯 任务概述

基于 `Report_baseline_rerun_2026-01-01.md:1`，当前 baseline 已确认：摩擦已对齐、左右镜像在关键帧上基本排除、且已启用 `--mpm-marker warp`。但 MPM 的 marker 仍表现为“接触区多数不动 + 少量短横线/抽风”，对应的第一性证据是 `uv_disp_mm` 在接触区呈现“稀疏 + 尖峰”，同时高度场仍存在离群值导致 halo 风险。

本计划目标：用最短路径把问题拆成可验收的链路（高度场伪影 → 位移场分布 → warp 映射/边界 → 物理标定），并产出可复跑的命令、指标与回归哨兵，最终让 MPM 的接触区 marker 位移在视觉与定量上更接近 FEM 的预期。

> 工具说明：当前运行环境未提供 `mcp__sequential-thinking__sequentialthinking` MCP 接口（无法调用），以下为手工分解，计划步数对标 7 步思考结果。

📋 执行计划

1. **固化 baseline 与验收口径（先定义“什么叫更好”）**
   - 产出：统一的“关键帧集合 + ROI + 指标”定义（至少包含 `frame_0075/0080/0085` 与 `press_end/slide_mid/hold_end`），并把它写入一个可复跑的说明文档（或更新既有报告附录）。
   - 验收：对同一 `save_dir` 运行一次分析即可复现报告中的核心统计（高度极值/梯度、接触区 `u_p50/u_p90/max`、flip 判定）。

2. **去伪影优先：开启高度场离群裁剪（只动渲染后处理，不动物理）**
   - 操作：复跑一次 `--mpm-height-clip-outliers on --mpm-height-clip-outliers-min-mm 2.0`（报告已给出参考命令），输出到新目录（如 `baseline_clip2`）。
   - 验收：`analysis_latest.csv` 中 `phenomena_tags` 的 `halo_risk` 触发显著减少，且 PNG 中的 halo/暗盘主观收敛；同时确认不会引入新的 marker 边缘伪影。

3. **把 `uv_disp_mm` 当成主证据：定位“稀疏 + 尖峰”的来源**
   - 操作：对 `frame_0075/0080/0085` 的 intermediate 输出做分解统计：接触区 coverage（非零/非 NaN 占比）、`u`/`|uv|` 分布、空间热力图，并和 FEM 的光流 ROI 指标对齐。
   - 验收：能回答两个可执行问题：A) 为什么 `u_p50≈0`（大面积 stick？还是提取/填洞导致的“归零”）；B) `max≈1mm` 的尖峰出现在哪些区域（边缘？接触圈？孔洞填补区？）。

4. **Ablation：高度场提取/填洞/平滑参数对 `uv_disp_mm` 的副作用评估**
   - 操作：仅对“surface fields”链路做消融实验（保持物理不变），例如：关/开 `mpm_height_fill_holes`、调整 `mpm_height_fill_holes_iters`、调整 `mpm_height_smooth_iters`，比较 `uv_disp_mm` 的 coverage 与尖峰指标。
   - 验收：形成一张“参数 → 现象（稀疏/尖峰/halo）”的表，明确下一步是继续调参即可，还是需要新增更稳健的 outlier/edge 处理。

5. **warp 稳健性：边界/出界处理一致化（消除“短横线/拉丝”观感）**
   - 操作：审查并验证 `warp_marker_texture()` 的 remap 边界策略（cv2 vs numpy 分支）。必要时增加“诊断模式”：对 remap 坐标做 clamp 或改用 constant border 以排除 REFLECT101 的镜像拖影。
   - 验收：关键帧接触区与图像边缘不再出现明显“拉丝/短横线”伪影；同时保持 marker 点阵清晰度不退化。

6. **坐标/翻转收敛：确保“只翻一次”且约定可追溯**
   - 操作：基于 `run_manifest.json` 的 conventions，收敛并文档化：`uv_disp_mm` 的正方向、图像坐标系与 `flip_x/flip_y` 的职责边界（生成/场/warp/overlay 哪一层负责）。
   - 验收：用 `analyze_rgb_compare_flip_alignment.py` 对关键帧做自动判定时，能稳定得到 `direct/noflip`（或稳定的唯一组合），且与肉眼观察一致。

7. **物理标定（材料优先，其次接触/摩擦）：把“中部不动”拉回合理量级**
   - 操作：在保持 `press=1mm` 的前提下，优先 sweep `--mpm-ogden-mu/--mpm-ogden-kappa`，再在小范围内 sweep `mpm_contact_stiffness_{normal,tangent}`；每次记录 ROI 光流 `dx_p50` 与接触区 `u_p50/u_p90`。
   - 验收：MPM 的接触区 ROI 指标从当前“弱且不连续”提升到与 FEM 同量级（可先定义一个宽松目标：`dx_p50` 达到 FEM 的 50%+，且 `u_p50` 明显大于 0），同时不引入更严重的 halo/离群。

8. **默认 marker 位移 + 启动方式固化（面向使用者的收敛）**
   - 操作：如果要把“默认 marker 行为”从 `static` 改为 `warp`（属于行为变更），先按 `openspec/AGENTS.md` 走 proposal；否则至少提供一个“推荐基线命令/预设配置”，并更新 `quick_test.py` / 示例文档以默认展示 warp 效果。
   - 验收：新用户按文档命令启动即可复现“marker 随接触区产生可见位移”的效果；并明确如何切回 `static` 以兼容旧流程。

⚠️ 风险与注意事项

- **物理 vs 渲染耦合**：`uv_disp_mm` 的“稀疏/尖峰”可能同时来自物理（stick/slip 分布）与 surface field 后处理；必须先做消融实验，避免把渲染问题误判成材料问题。
- **行为变更风险**：将默认 marker 改为 warp 可能影响既有回归图像；需要 OpenSpec proposal 与明确迁移策略（保持兼容开关/默认值变更说明）。
- **验证成本**：参数 sweep 会显著增加运行时间；需要先用关键帧/短跑策略与离线分析脚本做快速筛选，再做全量复跑。

📎 参考

- `Report_baseline_rerun_2026-01-01.md:1`
- `output/rgb_compare/baseline/run_manifest.json:1`
- `output/rgb_compare/baseline/analysis_latest.csv:1`
- `output/rgb_compare/baseline/alignment_flip_latest.csv:1`
- `output/rgb_compare/baseline/intermediate/frame_0085.npz:1`
- `example/analyze_rgb_compare_intermediate.py:1`
- `example/analyze_rgb_compare_flip_alignment.py:1`
- `example/mpm_fem_rgb_compare.py:474`（marker warp）
- `example/mpm_fem_rgb_compare.py:1368`（surface fields/uv 提取）
- `xengym/mpm/contact.py:224`（接触/摩擦）
- `xengym/mpm/mpm_solver.py:227`（grid contact 入口）
