# 位移平台XYZ三轴独立控制工具使用说明

## 概述

`stage_control_xyz.py` 是一个基于PyQt5的图形化控制工具，用于位移平台的XYZ三轴独立精确控制。

## 功能特性

### 1. **XYZ三轴完全独立控制**
- X轴：前后运动
- Y轴：左右运动
- Z轴：上下运动

### 2. **双模式控制**
- **粗调模式**：快速移动，步数范围 1-10000
- **微调模式**：精细控制，支持脉冲数 × 重复次数 × 时间间隔

### 3. **ATI力传感器实时显示**
- 三维力 (Fx, Fy, Fz)
- 三维力矩 (Tx, Ty, Tz)
- 100ms刷新率

### 4. **安全机制**
- 急停按钮（STOP命令）
- 控制锁定/解锁
- 参数范围验证

### 5. **串口自动连接**
- 自动尝试常用端口：COM10, COM11, COM9, COM7
- Linux支持：/dev/ttyUSB0, /dev/ttyACM0

## 安装依赖

```bash
pip install pyserial PyQt5
pip install pyati  # ATI传感器（可选）
```

## 使用方法

### 启动程序

```bash
python calibration/stage_control_xyz.py
```

### 界面说明

#### 左侧：控制区

1. **串口连接区**
   - 自动连接候选端口
   - 手动刷新和连接
   - 连接状态显示

2. **粗调控制**
   - 选择轴：X/Y/Z
   - 选择方向：向前(+) / 向后(-)
   - 输入步数：1-10000
   - 点击"发送X轴"执行

3. **微调控制**（每轴独立）
   - **单次脉冲数**：每次移动的步数
   - **重复次数**：连续移动的次数
   - **时间间隔(ms)**：每次移动的间隔
   - **实时统计**：总步数和总耗时
   - 点击"发送X微调"执行

#### 右侧：状态显示区

1. **急停控制**
   - 红色"急停"按钮：立即停止所有运动
   - 绿色"取消急停"按钮：解锁控制

2. **ATI传感器显示**（如果可用）
   - 绿色：三维力 (N)
   - 黄色：三维力矩 (Nm)

3. **串口反馈**
   - 黑底绿字终端样式
   - 显示所有命令和响应
   - "清屏"按钮清空日志

## 命令格式

### 粗调命令
```
X 0 100  # X轴向后运动100步
Y 1 200  # Y轴向前运动200步
Z 0 50   # Z轴向上运动50步
```

### 微调命令
```
XADJ 1 10 5 500  # X轴向前，单次10步，重复5次，间隔500ms
YADJ 0 5 10 300  # Y轴向后，单次5步，重复10次，间隔300ms
ZADJ 1 20 3 1000 # Z轴向下，单次20步，重复3次，间隔1000ms
```

### 控制命令
```
STOP    # 急停
RESUME  # 恢复
```

## 参数限制

| 参数 | 范围 | 说明 |
|------|------|------|
| 步数 | 1-10000 | 单次移动的最大步数 |
| 脉冲数 | >0 | 微调单次脉冲数 |
| 重复次数 | >0 | 微调重复次数 |
| 时间间隔 | ≥10ms | 微调时间间隔 |
| 总步数 | ≤10000 | 脉冲数×重复次数 |

## 使用场景

### 1. 数据采集前调试
```
1. 启动程序
2. 使用粗调将传感器移动到物体正上方
3. 使用Z轴微调进行精确接触检测
4. 记录位置，用于数据采集脚本
```

### 2. 接触力测试
```
1. 观察ATI力传感器Fz值
2. 使用Z轴微调（单次1-2步，重复10次，间隔500ms）
3. 缓慢下降直到Fz达到目标值（如-0.03N）
```

### 3. 位置校准
```
1. X/Y轴粗调定位到大致位置
2. X/Y轴微调进行精确对齐
3. Z轴归零后开始采集
```

## 故障排除

### 串口连接失败
```
问题：未找到可用的串口
解决：
1. 检查USB连接
2. 确认设备管理器中的端口号
3. 手动选择端口并点击"连接"
```

### ATI传感器无法连接
```
问题：ATI传感器连接失败
解决：
1. 检查传感器IP：192.168.1.10
2. 确认网络连接
3. 验证pyati库已安装
4. 传感器功能为可选，不影响位移平台控制
```

### 运动不响应
```
问题：发送命令后无运动
解决：
1. 检查串口连接状态
2. 确认未处于急停锁定状态
3. 查看串口反馈区的错误信息
4. 检查下位机固件状态
```

### 步数参数错误
```
问题：提示"步数无效"
解决：
1. 粗调：确保步数在1-10000范围
2. 微调：确保脉冲数×重复次数≤10000
3. 微调：确保时间间隔≥10ms
```

## 与数据采集脚本的配合

1. **stage_control_xyz.py**：手动调试和校准
   - XYZ三轴完全自由控制
   - 实时ATI力反馈
   - 适合上机前测试

2. **collect_real_data.py**：自动数据采集
   - XY预设，Z自动压入
   - 轨迹自动执行
   - 数据实时保存

## 技术参数

- **串口**：115200 8N1
- **通信协议**：ASCII文本 + \r\n
- **ATI刷新率**：100ms
- **串口读取**：100ms轮询
- **窗口尺寸**：1200×700像素

## 注意事项

1. **安全第一**：测试时始终准备按急停按钮
2. **步进限制**：避免单次移动过大导致碰撞
3. **力传感器**：注意Fz值，避免过大压力
4. **串口占用**：同时只能一个程序连接串口
5. **坐标系**：确认XYZ方向与实际平台一致

## 与其他工具对比

| 工具 | 用途 | XYZ控制 | ATI显示 | 自动采集 |
|------|------|---------|---------|----------|
| stage_control_xyz.py | 手动调试 | ✅ 完全独立 | ✅ 实时 | ❌ |
| stage_control_gui.py | 简易控制 | ⚠️ A/B命令 | ✅ 日志 | ❌ |
| collect_real_data.py | 数据采集 | ⚠️ Z自动 | ✅ 后台 | ✅ |

**推荐工作流**：
1. 使用 `stage_control_xyz.py` 进行初始校准和测试
2. 确定XY位置后，使用 `collect_real_data.py` 进行批量数据采集

## 开发者信息

- 基于 `host_machine_chinese.py` 改编
- 适配数据采集用3轴位移平台
- PyQt5图形界面
- 支持ATI力传感器集成